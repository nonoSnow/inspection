<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>停水通知单处理界面</title>
    <link rel="stylesheet" type="text/css" href="../../public/css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../public/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../public/css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../public/css/vant.css" />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            background-color: #F3F3F3;
        }

        .aui-bar-nav {
            top: 0;
            z-index: 1;
            background: linear-gradient(90deg, rgba(46, 142, 250, 1), rgba(49, 89, 235, 1));
            color: #FFF;
            font-size: 0.95rem;
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0rem;
        }

        .aui-bar-nav .aui-btn .aui-iconfont {
            color: #FFF;
            font-weight: 900;
        }

        .aui-bar-nav .aui-pull-right {
            font-size: 0.95rem;
        }

        .flex-con {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        [v-cloak] {
            display: none;
        }

        .aui-info {
            background: #fff;
            height: 3rem;
            padding: 0.5rem 1rem;
        }

        .posting-title {
            font-size: 1rem;
            font-family: Source Han Sans SC;
            font-weight: 400;
            color: #000;
        }

        .posting-time {
            font-size: 0.8rem;
        }

        .footer {
            width: 100vw;
            height: 2.5rem;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.35rem;
        }

        .van-button {
            width: 30%;
            margin-left: 2.5%;
            height: 1.86rem;
            line-height: normal;
            font-size: 0.95rem;
            color: #fff;
        }

        .aui-content {
            height: 100%;
            overflow: hidden;
            background-color: #F3F3F3;
            width: 92%;
            margin: 0 auto;
            border-radius: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .content {
            border-radius: 0.8rem;
            height: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0.8rem 1.25rem;
            background: white;
            padding-bottom: 0.3rem;
        }

        .row {
            line-height: 2rem;
            border-bottom: 1px solid #F2F2F2;
        }

        .text-left {
            width: 38%;
            font-size: 0.9rem;
            display: inline-block;
        }

        .text-left-title {
            display: inline-block;
            text-align: justify;
            text-align-last: justify;
            width: 90%;
        }

        .text-right {
            margin-left: 0px;
            font-size: 0.9rem;
            color: #656265;
            display: inline-block;
            width: calc(60% - 0px);
            overflow: auto;
            ;
            vertical-align: top;
            padding-left: 0.2rem;
        }

        .textarea {
            border: 1px solid #D8D8D8;
            border-radius: 0.13rem;
            padding: 0.25rem 0.5rem;
            color: #626262;
            height: 4rem;
            position: relative;
        }

        .textarea textarea {
            line-height: 1.5;
            border-radius: 3px;
            width: 100%;
            height: 100%;
            var(--fontsize8);
        }

        .in {
            position: absolute;
            bottom: 0.2rem;
            right: 1rem;
            color: #CCC;
            font-size: 0.7rem;
        }

        .images {
            vertical-align: text-top;
        }

        .images>img {
            width: 1.05rem;
            height: 0.85rem;
            float: right;
        }

        .addressIcon {
            background: url(../image/MeterManage/dingwei.png) no-repeat 0 0;
            background-size: 100% 100%;
            width: .6rem;
            height: .7rem;
            display: inline-block;
        }

        .textColor {
            color: #2045FF;
        }

        .phont {
            width: 3.6rem;
            height: 2.8rem;
            position: relative;
            display: inline-block;
            margin-right: .7rem;
        }

        .phont img {
            width: 100%;
            height: 100%;
        }

        .delectImg {
            background: url(../image/MeterManage/shanchu.png) no-repeat 0 0;
            background-size: 100% 100%;
            width: .8rem;
            height: .8rem;
            display: inline-block;
            position: absolute;
            right: -7px;
            top: -7px;
        }

        .van-dialog .van-button {
            font-size: 0.95rem;
            height: 2.75rem;
            line-height: 2.75rem;
        }

        .van-dialog__confirm,
        .van-dialog__confirm:active {
            color: #2F7DF5;
        }

        .van-dialog__cancel,
        .van-dialog__cancel:active {
            color: #000;
        }
    </style>
</head>

<body>
    <div id="wrap" class="flex-wrap flex-vertical">
        <header class="aui-bar aui-bar-nav" id="header">
            <div class="aui-pull-left aui-btn" tapmode @click='onBack'>
                <span class="aui-iconfont aui-icon-left"></span>
            </div>
            <div class="aui-title">张贴列表</div>
        </header>
        <div class="aui-info">
            <div class="aui-info-item">
                <span class="aui-margin-l-5 posting-title">张贴停水通知单</span>
            </div>
            <div class="aui-info-item posting-time">{{UserDetails.OperatedTime}}</div>
        </div>
        <div class="flex-con aui-content">
            <div class="content">
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">户名</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.CustomerName}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">户号</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.CustomerCode}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">地址</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.Address}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">用水性质</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.Nature}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">用量</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.Amount}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">起度</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.BeginScale}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">止度</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.EndScale}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">抄表类型</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.Nature}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">欠费金额</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.ArrearMoney}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">欠费次数</span>:
                    </div>
                    <div class="text-right">
                        <span>{{UserDetails.ArrearMoneyNum}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">备注</span>:
                    </div>
                    <div class="textarea" style="margin-bottom: 8px;">
                        <textarea name="name" rows="16" cols="80" :readonly='isRemark || isClaim' placeholder="请输入备注说明" v-model="UserDetails.SaveRemark"></textarea>
                        <div class="in">100</div>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">照片</span>
                    </div>
                    <div class="text-right images">
                        <img @click="onOpenCamera" src="../image/MeterManage/paizhao.png" alt="">
                    </div>
                    <div class="photoList">
                        <div class="phont" v-for="(item,index) in photoList" :key="index">
                            <i class="delectImg" @click="onDelectPic(index)"></i>
                            <img :src="item" alt="" @click="pBrowserPicture(index, photoList)">
                        </div>
                    </div>
                </div>
                <div class="row" style="border-bottom: none;">
                    <p @click='onGetLocation'>
                        <i class="addressIcon"></i>
                        <span class="textColor">{{Location}}</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="footer">
            <van-button round block color='rgba(55, 126, 255, 1)' @click='onLastUser'>
                上一户
            </van-button>
            <van-button round block color="rgba(12, 206, 81, 1)" :disabled='isClaim' @click='onSubMit'>
                完成
            </van-button>
            <van-button round block color='rgba(55, 126, 255, 1)' @click='onNextUser'>
                下一户
            </van-button>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../public/script/api.js"></script>
<script type="text/javascript" src="../../public/script/common.js"></script>
<script type="text/javascript" src="../../public/script/remote.js"></script>
<script type="text/javascript" src="../../public/script/publicMethod.js"></script>
<script type="text/javascript" src="../../public/script/vue/fastclick.min.js"></script>
<script type="text/javascript" src="../../public/script/vue/vue.min.js"></script>
<script type="text/javascript" src="../../public/script/vue/vant.min.js"></script>
<script type="text/javascript" src="../../public/script/vue/vueTouch.js"></script>
<script type="text/javascript" src="../../public/script/moment.js"></script>
<script type="text/javascript" src="../script/remote.js"></script>
<script type="text/javascript" src="../script/meterManageLocalData.js"></script>
<script type="text/javascript" src="../../public/script/diy/public.js"></script>
<script type="text/javascript">
    var db;
    apiready = function() {
        var header = $api.byId('header');
        $api.fixStatusBar(header);

        db = api.require("db");

        api.addEventListener({
            name: 'volumeup'
        }, function(ret, err) {
            ApplyTaskVue.onLastUser();
        });

        api.addEventListener({
            name: 'volumedown'
        }, function(ret, err) {
            ApplyTaskVue.onNextUser();
        });

        fnIntVue();
        Origami.fastclick(document.body) //消除vue的ios端点击延迟
    }

    function fnIntVue() {
        window.ApplyTaskVue = new Vue({
            el: '#wrap',
            data: {
                OperatedTime: '', //创建时间
                CustomerName: '', //户名
                CustomerCode: '', //户号
                Address: '', //地址
                Nature: '', //用水性质
                Amount: '', //用量
                BeginScale: '', //起度
                EndScale: '', //止度
                ArrearMoney: '', //欠费金额
                ArrearMoneyNum: '', //欠费次数
                Location: '', //手机定位
                Longitude: 0, //经度
                Latitude: 0, //纬度

                isClaim: false, //是否认领
                remarkText: '', //备注信息
                photoList: [], //照片数组
                photoLocaltion: [],  // 照片位置数组

                userDataArr: [], //该任务中所有用户数据
                nowUserIndex: 0, //当前用户在整个用户数组中的下标
                UserDetails: {}, //当前用户数据

                isRemark: false,  // 备注是否可输入

                getTaskData: api.pageParam.data,
            },
            methods: {
                onBack() {
                    api.closeWin({});
                },
                onGetLocalData() {
                  var _that = this;
                  var selectResult = db.selectSqlSync({
                      name: 'Wsdatabase',
                      sql: 'SELECT * FROM POSTING_LIST where TaskNo = "' + _that.getTaskData.TaskNo + '" and Status ="7" and isUpload ="0" AND userName = "' + $api.getStorage('loginData').userName + '"'
                  });

                  if (selectResult.status) {
                    if (selectResult.data.length > 0) {
                      _that.userDataArr = selectResult.data;

                      for (var i = 0; i < _that.userDataArr.length; i++) {
                        if (_that.userDataArr[i].Id == _that.getTaskData.Id) {
                          _that.nowUserIndex = i;
                          _that.UserDetails = _that.userDataArr[i];
                          break;
                        }
                      }

                      _that.UserDetails.OperatedTime = _that.UserDetails.OperatedTime.slice(0, 10);
                      _that.onJudgeFnc();

                    } else {
                      vant.Toast('本地未查询到数据');
                    }
                  } else {
                    vant.Toast('本地未查询到数据');
                  }

                },
                onTaskNotTermination() {
                  var _taht = this;
                  // 查询当前任务状态
                  api.showProgress({
                      style: 'default',
                      animationType: 'fade',
                      title: '加载中...',
                      modal: false
                  });

                  api.ajax({
                      url: 'http://' + $api.getStorage('apiUrl') + '/api/services/app/WorkFlow/GetTaskStatus?TaskCode=' + _that.UserDetails.TaskNo + '&Account='+ $api.getStorage('bwUserName') +'&PassWord='+ $api.getStorage('bwPassWord'),
                      method: 'get',
                      dataType: "json",
                      returnAll: false,
                      headers: {
                          "Content-Type": "application/json",
                          "Authorization": $api.getStorage('loginInfo')
                      }
                  },function(ret, err){
                      api.hideProgress();
                      if (ret) {
                          if (ret.success) {
                              if (ret.result == true) {
                                //任务为可办理
                                var body = {
                                  Id: _that.UserDetails.Id
                                }
                                //查询当前任务状态及欠费金额
                                fnPost('MMS009', body, 'application/json', false, false, function(ret, err) {
                                  api.hideProgress();
                                  if (ret && ret.Status == '0') {

                                    if (JSON.parse(ret.Data).StatusId != 7) {
                                      // 删除本地数据
                                      var result = db.executeSqlSync({
                                          name: 'Wsdatabase',
                                          sql: "DELETE FROM POSTING_LIST WHERE Id = '"+ _that.UserDetails.Id +"'  AND userName = '"+ $api.getStorage('loginData').userName +"'"
                                      });
                                      console.log(JSON.stringify(result));

                                      api.sendEvent({
                                          name: 'reFlashPostingTask',
                                          extra: {
                                              key1: 'value1',
                                              key2: 'value2'
                                          }
                                      });

                                      vant.Dialog.confirm({
                                              title: '工单终止',
                                              message: '终止原因：' + JSON.parse(ret.Data).Message
                                          })
                                          .then(function() {
                                            api.closeWin({});
                                          })
                                          .catch(function() {
                                              api.closeWin({});
                                              return;
                                          });

                                    } else {
                                      var result = db.executeSqlSync({
                                          name: 'Wsdatabase',
                                          sql: "UPDATE POSTING_LIST SET ArrearMoney = '"+ JSON.parse(ret.Data).ArrearMoney +"' WHERE Id = '"+ _that.UserDetails.Id +"' AND userName = '"+ $api.getStorage('loginData').userName +"'"
                                      });
                                      console.log(JSON.stringify(result));
                                      _that.UserDetails.ArrearMoney = JSON.parse(ret.Data).ArrearMoney;
                                      if (_that.UserDetails.ArrearMoney == '' || that.UserDetails.ArrearMoney == ' ' || that.UserDetails.ArrearMoney == '0') {
                                        _that.isRemark = true;
                                        vant.Dialog.confirm({
                                                title: '提示',
                                                message: '用户已缴费,无需处理可直接点击完成'
                                            })
                                            .then(function() {
                                            })
                                            .catch(function() {
                                                return;
                                            });
                                      }

                                    }

                                  }
                                });
                              } else {
                                //任务为不可办理
                                var result = db.executeSqlSync({
                                    name: 'Wsdatabase',
                                    sql: "DELETE FROM POSTING_LIST WHERE TaskNo = '"+ _that.UserDetails.TaskNo +"'  AND userName = '"+ $api.getStorage('loginData').userName +"'"
                                });
                                console.log(JSON.stringify(result));

                                vant.Dialog.confirm({
                                        title: '提示',
                                        message: '此任务所有相关工单已被终止'
                                    })
                                    .then(function() {
                                        api.closeWin({});
                                    })
                                    .catch(function() {
                                        api.closeWin({});
                                        return;
                                    });

                              }

                          }
                          console.log( JSON.stringify( ret ) );
                      } else {
                          console.log( JSON.stringify( err ) );
                      }
                  });

                },
                onOpenCamera() {
                    if (this.isClaim) {
                        return;
                    }
                    var _that = this;
                    api.actionSheet({
                        cancelTitle: '取消',
                        buttons: ['拍照', '相册']
                    }, function(ret, err) {
                        console.log(_that.CustomerCode)
                        var options = {
                            type: 'camera',
                            waterMark: true,
                            waterMarkData: {
                                code: _that.CustomerCode,
                            }
                        };
                        if (ret.buttonIndex == 1) { //打开相机
                            options.type = 'camera';
                        }
                        if (ret.buttonIndex == 2) {
                            options.type = 'pic';
                        }
                        if (ret.buttonIndex > 0 && ret.buttonIndex < 3) {
                            pGetPicture(options, function(ret, err) {
                                if (ret.status) {
                                    pGetNameFromCoords(function(ret, err) {
                                        var imgLon = '';
                                        var imgLat = '';
                                        if (ret.status) {
                                            imgLon = ret.lon;
                                            imgLate = ret.lat;
                                        }
                                        ret.imgList.forEach(function(item, index) {
                                            if (_that.photoList.length < 5) {
                                                _that.photoList.push(item);
                                                _that.photoLocaltion.push(imgLon + ',' + imgLate);
                                            } else {
                                                vant.Toast('最多只能上传5张图片');
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    });
                },
                onDelectPic(index) {
                    if (this.isClaim) {
                        return;
                    }
                    var _that = this;
                    vant.Dialog.confirm({
                            title: '提示',
                            message: '是否确定删除照片?',
                        })
                        .then(function() {
                            var fs = api.require("fs");
                            fs.remove({
                                path: _that.photoList[index]
                            });
                            _that.photoList.splice(index, 1);
                            _that.photoLocaltion.splice(index, 1);
                        })
                        .catch(function() {
                            return;
                        });
                },
                onGetLocation() {
                    this.Location = "正在定位中...";
                    this.Longitude = 0;
                    this.Latitude = 0;
                    var _that = this;
                    pGetNameFromCoords(function(ret, err) {
                        if (ret.status) {
                            _that.Longitude = ret.lon;
                            _that.Latitude = ret.lat;
                            _that.Location = ret.address;
                        } else {
                            _that.Location = "定位失败";
                        }
                    });
                },
                onLastUser() {
                    if (this.nowUserIndex == 0) {
                        vant.Toast('没有上一户了');
                        return;
                    }
                    this.nowUserIndex--;
                    this.UserDetails = this.userDataArr[this.nowUserIndex];

                    this.UserDetails.OperatedTime = this.UserDetails.OperatedTime.slice(0, 10);

                    this.onJudgeFnc();
                },
                onNextUser() {
                    if (this.nowUserIndex == (this.userDataArr.length - 1)) {
                        vant.Toast('没有下一户了');
                        return;
                    }
                    this.nowUserIndex++;
                    this.UserDetails = this.userDataArr[this.nowUserIndex];

                    this.UserDetails.OperatedTime = this.UserDetails.OperatedTime.slice(0, 10);

                    this.onJudgeFnc();
                },
                onJudgeFnc() {
                  if (api.connectionType != 'none') {
                      this.onTaskNotTermination();
                  } else {
                    if (this.UserDetails.ArrearMoney == " " || this.UserDetails.ArrearMoney == "" || this.UserDetails.ArrearMoney == "0") {
                        vant.Dialog.confirm({
                                title: '提示',
                                message: '用户已缴费,无需处理可直接点击完成'
                            })
                            .then(function() {
                            })
                            .catch(function() {
                                return;
                            });
                    } else {
                        vant.Dialog.confirm({
                                title: '提示',
                                message: '网络未连接无法判断是否缴费，是否处理?'
                            })
                            .then(function() {
                            })
                            .catch(function() {
                                return;
                            });
                    }
                  }
                },
                onNowTime() {
                  var myDate = new Date();
                  return myDate.getFullYear() + "-" + ((myDate.getMonth() + 1) < 10 ? "0"+(myDate.getMonth() + 1) : (myDate.getMonth() + 1)) + "-" +
                                (myDate.getDate() < 10 ? "0"+(myDate.getDate()) : (myDate.getDate()));
                },
                onSubMit() {
                  var _that = this;
                  var imgLocation = '';
                  for (var i = 0; i < this.photoLocaltion.length; i++) {
                    imgLocation += this.photoLocaltion[i];
                  }

                  // if (this.UserDetails.ArrearMoney != "" && this.UserDetails.ArrearMoney != " " || this.UserDetails.ArrearMoney != "0") {
                  //
                  // }

                  // 停水通知单数据及照片单独上传
                  if ($api.getStorage("stopWaterDataUpload") == 1 || api.connectionType == 'none') {
                    var msg = "";
                    if ($api.getStorage("stopWaterDataUpload") == 1) {
                      msg = '当前设置为数据单独上传，是否保存数据到本地？';
                    } else {
                      msg = '当前无网络，是否保存数据到本地？';
                    }
                    vant.Dialog.confirm({
                            title: '提示',
                            message: msg
                        })
                        .then(function() {
                          _that.onSaveData();
                        })
                        .catch(function() {
                            return;
                        });
                    return;
                  }

                  api.showProgress({
                      style: 'default',
                      animationType: 'fade',
                      title: '努力加载中...',
                      modal: true
                  });

                  var body = {
                    Id: _that.UserDetails.Id,
                    OperatedTime: _that.onNowTime(),
                    Status: '',
                    Remark: _that.UserDetails.SaveRemark,
                    FileLocation: imgLocation,
                    Type: ''
                  };

                  api.ajax({
                      url: $api.getStorage("bwapipath") + '/api/waterMeters/info',
                      method: 'post',
                      dataType: "json",
                      data: {
                          values: {
                              Method: "MMS006",
                              UserName: $api.getStorage("bwUserName"),
                              Password: $api.getStorage("bwPassWord"),
                              SerialNo: '11111111',
                              KeyCode: '',
                              Parameter: JSON.stringify(data)
                          },
                          files: {
                              file: _that.photoList
                          }
                      }
                  },function(ret, err){
                      api.hideProgress();
                      if (ret) {
                          console.log( JSON.stringify( ret ) );
                          if (ret.Status == '0') {
                              //提交成功  更改本地数据状态
                              var dataRet = db.executeSqlSync({
                                  name: 'Wsdatabase',
                                  sql: "UPDATE POSTING_LIST SET isUpload = '1' WHERE Id = '"+ _that.UserDetails.Id +"' AND userName = '"+ $api.getStorage('loginData').userName +"'"
                              });
                              console.log(JSON.stringify(dataRet));

                              vant.Toast('提交成功');
                              //查询当前任务是否全部提交
                              db.selectSql({
                                  name: 'Wsdatabase',
                                  sql: "SELECT * FROM POSTING_LIST WHERE TaskNo = '"+ _that.UserDetails.TaskNo +"' AND isUpload = '0' AND userName = '"+ $api.getStorage('loginData').userName +"'"
                              }, function(ret, err){
                                  if( ret.status ){
                                      console.log( JSON.stringify( ret ) );
                                      if (ret.data.length == 0) {
                                        //最后一户删除云平台停水通知单数据
                                        var deleteRet = db.executeSqlSync({
                                            name: 'Wsdatabase',
                                            sql: 'DELETE FROM myTaskSheet where taskCode="' + _that.UserDetails.TaskNo + '" AND userName = "' + $api.getStorage('loginData').userName + '"'
                                        });
                                        console.log( JSON.stringify( deleteRet ) );

                                        vant.Dialog.confirm({
                                                title: '提示',
                                                message: '任务已全部处理完成'
                                            })
                                            .then(function() {
                                              api.closeWin({});
                                            })
                                            .catch(function() {
                                                api.closeWin({});
                                                return;
                                            });
                                      }
                                  }else{
                                      console.log( JSON.stringify( err ) );
                                  }
                              });

                          }
                      } else {
                          console.log( JSON.stringify( err ) );
                      }
                  });

                },
                onSaveData() {
                  var _that = this;
                  var SavePhoto = '';
                  var PhotoLocation = '';
                  for (var i = 0; i < _that.photoList.length; i++) {
                    SavePhoto += _that.photoList[i] + '|';
                    PhotoLocation += _that.photoLocaltion[i] + '|';
                  }
                  if (SavePhoto != "") {
                    SavePhoto = SavePhoto.substring(0,SavePhoto.length - 1);
                  }
                  if (PhotoLocation != "") {
                    PhotoLocation = PhotoLocation.substring(0,PhotoLocation.length - 1);
                  }

                  var saveSql = "UPDATE POSTING_LIST SET " +
                                "SaveTime = '"+ _that.onNowTime() +"', " +
                                "SaveRemark = '"+ _that.UserDetails.SaveRemark +"', " +
                                "SavePhoto = '"+ SavePhoto +"', " +
                                "PhotoLocation = '"+ PhotoLocation +"', " +
                                "isSave = '1' WHERE Id = '"+ _that.UserDetails.Id +"' AND userName = '"+ $api.getStorage('loginData').userName +"'";
                  db.executeSql({
                      name: 'Wsdatabase',
                      sql: saveSql
                  }, function(ret, err){
                      if( ret.status ){
                          console.log( JSON.stringify( ret ) );
                          vant.Toast('数据保存本地成功');
                      }else{
                          console.log( JSON.stringify( err ) );
                      }
                  });

                }
            },
            mounted: function() {
                this.userDataArr = [{
                    OperatedTime: '2020-09-03',
                    CustomerName: '张三',
                    CustomerCode: '01010002',
                    Address: '马栏山马兰坡马兰村1号',
                    Nature: '居民用水',
                    Amount: '5',
                    BeginScale: '5',
                    EndScale: '10',
                    ArrearMoney: '1.25',
                    ArrearMoneyNum: '0'
                }, {
                    OperatedTime: '2020-09-04',
                    CustomerName: '李四',
                    CustomerCode: '01010003',
                    Address: '马栏山马兰坡马兰村2号',
                    Nature: '居民用水',
                    Amount: '15',
                    BeginScale: '15',
                    EndScale: '30',
                    ArrearMoney: '2.50',
                    ArrearMoneyNum: '3'
                }, {
                    OperatedTime: '2020-09-05',
                    CustomerName: '王五',
                    CustomerCode: '01010004',
                    Address: '马栏山马兰坡马兰村3号',
                    Nature: '居民用水',
                    Amount: '20',
                    BeginScale: '20',
                    EndScale: '40',
                    ArrearMoney: '8.57',
                    ArrearMoneyNum: '1'
                }, ];

                this.UserDetails = this.userDataArr[this.nowUserIndex];

                if (api.pageParam.taskType == "claimTask") {
                  this.isClaim = true;
                } else if (api.pageParam.taskType == "handle") {
                  this.isClaim = false;
                }

                this.onGetLocation();
            }
        });
    }
</script>

</html>
